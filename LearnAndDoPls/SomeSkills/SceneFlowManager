using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.SceneManagement;
using CDTU.Utils;

/// <summary>
/// 跨场景数据与加载流程管理器，封装 Unity SceneManager。
/// - 提供数据跨场景存取（键值对）
/// - 提供同步/异步加载、重载、附加加载
/// - 常驻单例（DontDestroyOnLoad）
/// </summary>
public class SceneFlowManager : SingletonDD<SceneFlowManager>
{
    // 跨场景数据存储（简单键值对）
    private readonly Dictionary<string, object> dataStore = new();

    // 加载状态
    public float LoadingProgress { get; private set; }
    public bool IsLoading => loadRoutine != null;
    private Coroutine loadRoutine;

    #region 数据存取

    /// <summary>写入/更新数据；value 传 null 表示移除该键。</summary>
    public void SetData<T>(string key, T value)
    {
        if (string.IsNullOrEmpty(key)) return;
        if (value == null)
        {
            dataStore.Remove(key);
        }
        else
        {
            dataStore[key] = value;
        }
    }

    /// <summary>读取数据（带默认值）。</summary>
    public T GetData<T>(string key, T defaultValue = default)
    {
        if (string.IsNullOrEmpty(key)) return defaultValue;
        if (dataStore.TryGetValue(key, out var obj) && obj is T t) return t;
        return defaultValue;
    }

    /// <summary>尝试读取数据。</summary>
    public bool TryGetData<T>(string key, out T value)
    {
        if (!string.IsNullOrEmpty(key) && dataStore.TryGetValue(key, out var obj) && obj is T t)
        {
            value = t;
            return true;
        }
        value = default;
        return false;
    }

    /// <summary>移除指定键。</summary>
    public void ClearData(string key)
    {
        if (string.IsNullOrEmpty(key)) return;
        dataStore.Remove(key);
    }

    /// <summary>清空所有跨场景数据。</summary>
    public void ClearAllData() => dataStore.Clear();

    #endregion

    #region 场景加载 API

    /// <summary>同步加载场景（会打断当前加载）。</summary>
    public void LoadScene(string sceneName, Action onCompleted = null)
    {
        if (IsLoading) StopCurrentLoad();
        SceneManager.LoadScene(sceneName, LoadSceneMode.Single);
        onCompleted?.Invoke();
    }

    /// <summary>通过场景索引同步加载场景。</summary>
    public void LoadScene(int buildIndex, Action onCompleted = null)
    {
        if (IsLoading) StopCurrentLoad();
        SceneManager.LoadScene(buildIndex, LoadSceneMode.Single);
        onCompleted?.Invoke();
    }

    /// <summary>异步加载场景（Single）。</summary>
    public void LoadSceneAsync(string sceneName, Action onCompleted = null)
    {
        StartLoad(sceneName, LoadSceneMode.Single, onCompleted);
    }

    /// <summary>通过场景索引异步加载场景（Single）。</summary>
    public void LoadSceneAsync(int buildIndex, Action onCompleted = null)
    {
        StartLoad(buildIndex, LoadSceneMode.Single, onCompleted);
    }

    /// <summary>异步附加加载场景（Additive）。</summary>
    public void LoadSceneAdditiveAsync(string sceneName, Action onCompleted = null)
    {
        StartLoad(sceneName, LoadSceneMode.Additive, onCompleted);
    }

    /// <summary>通过场景索引异步附加加载场景（Additive）。</summary>
    public void LoadSceneAdditiveAsync(int buildIndex, Action onCompleted = null)
    {
        StartLoad(buildIndex, LoadSceneMode.Additive, onCompleted);
    }

    /// <summary>重载当前场景。</summary>
    public void ReloadCurrent(Action onCompleted = null)
    {
        LoadSceneAsync(SceneManager.GetActiveScene().name, onCompleted);
    }

    /// <summary>加载下一个场景（按 Build Index 顺序）。</summary>
    public void LoadNextScene(Action onCompleted = null)
    {
        int nextIndex = SceneManager.GetActiveScene().buildIndex + 1;
        if (nextIndex < SceneManager.sceneCountInBuildSettings)
        {
            LoadSceneAsync(nextIndex, onCompleted);
        }
        else
        {
            Debug.LogWarning("[SceneFlowManager] 已经是最后一个场景");
        }
    }

    /// <summary>加载上一个场景（按 Build Index 顺序）。</summary>
    public void LoadPreviousScene(Action onCompleted = null)
    {
        int prevIndex = SceneManager.GetActiveScene().buildIndex - 1;
        if (prevIndex >= 0)
        {
            LoadSceneAsync(prevIndex, onCompleted);
        }
        else
        {
            Debug.LogWarning("[SceneFlowManager] 已经是第一个场景");
        }
    }

    /// <summary>卸载附加场景。</summary>
    public void UnloadSceneAsync(string sceneName, Action onCompleted = null)
    {
        StartCoroutine(UnloadCoroutine(sceneName, onCompleted));
    }

    #endregion

    #region 内部加载流程

    private void StartLoad(string sceneName, LoadSceneMode mode, Action onCompleted = null)
    {
        if (IsLoading) StopCurrentLoad();
        loadRoutine = StartCoroutine(LoadCoroutine(sceneName, mode, onCompleted));
    }

    private void StartLoad(int buildIndex, LoadSceneMode mode, Action onCompleted = null)
    {
        if (IsLoading) StopCurrentLoad();
        loadRoutine = StartCoroutine(LoadCoroutine(buildIndex, mode, onCompleted));
    }

    private IEnumerator LoadCoroutine(string sceneName, LoadSceneMode mode, Action onCompleted = null)
    {
        LoadingProgress = 0f;
        var op = SceneManager.LoadSceneAsync(sceneName, mode);
        op.allowSceneActivation = true;

        while (!op.isDone)
        {
            LoadingProgress = op.progress;
            yield return null;
        }

        LoadingProgress = 1f;
        loadRoutine = null;
        onCompleted?.Invoke();
    }

    private IEnumerator LoadCoroutine(int buildIndex, LoadSceneMode mode, Action onCompleted = null)
    {
        LoadingProgress = 0f;
        var op = SceneManager.LoadSceneAsync(buildIndex, mode);
        op.allowSceneActivation = true;

        while (!op.isDone)
        {
            LoadingProgress = op.progress;
            yield return null;
        }

        LoadingProgress = 1f;
        loadRoutine = null;
        onCompleted?.Invoke();
    }

    private IEnumerator UnloadCoroutine(string sceneName, Action onCompleted)
    {
        var op = SceneManager.UnloadSceneAsync(sceneName);
        while (op != null && !op.isDone)
        {
            LoadingProgress = op.progress;
            yield return null;
        }
        LoadingProgress = 1f;
        onCompleted?.Invoke();
    }

    private void StopCurrentLoad()
    {
        if (loadRoutine != null)
        {
            StopCoroutine(loadRoutine);
            loadRoutine = null;
        }
    }

    #endregion

    protected override void OnDestroy()
    {
        // 清理跨场景数据存储
        if (dataStore != null) dataStore.Clear();
        if (loadRoutine != null) StopCoroutine(loadRoutine);
        
        base.OnDestroy();
    }
}

